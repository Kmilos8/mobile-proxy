---
phase: 01-openvpn-throughput
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/deployments/openvpn/client-connect-ovpn.sh
  - server/deployments/openvpn/client-disconnect-ovpn.sh
autonomous: false
requirements:
  - PROTO-01
  - PROTO-02

must_haves:
  truths:
    - "client-connect-ovpn.sh exits non-zero when the API call fails, causing OpenVPN to reject the client"
    - "client-connect-ovpn.sh retries the API call once before failing"
    - "client-disconnect-ovpn.sh exits non-zero when the API call fails (best effort logging)"
    - "HTTP and SOCKS5 DNAT rules are not affected by OpenVPN REDIRECT rule changes"
    - "OpenVPN iptables REDIRECT rules use -A (append) in PREROUTING, separate from DNAT rules"
  artifacts:
    - path: "server/deployments/openvpn/client-connect-ovpn.sh"
      provides: "OpenVPN connect hook with proper error handling and retry"
      contains: "exit 1"
    - path: "server/deployments/openvpn/client-disconnect-ovpn.sh"
      provides: "OpenVPN disconnect hook with proper error handling"
      contains: "exit 1"
  key_links:
    - from: "server/deployments/openvpn/client-connect-ovpn.sh"
      to: "API /internal/openvpn/connect"
      via: "wget POST synchronous call"
      pattern: "wget.*openvpn/connect"
    - from: "API /internal/openvpn/connect"
      to: "tunnel /openvpn-client-connect"
      via: "HTTP POST to tunnel push API"
      pattern: "openvpn-client-connect"
    - from: "tunnel /openvpn-client-connect"
      to: "iptables REDIRECT"
      via: "iptables -A PREROUTING -s <client_ip> -j REDIRECT"
      pattern: "REDIRECT.*12345"
---

<objective>
Fix the silent failure bug in client-connect-ovpn.sh that admits OpenVPN clients even when the transparent proxy mapping and iptables REDIRECT rule setup fails, and verify HTTP/SOCKS5 DNAT rule isolation from OpenVPN changes.

Purpose: The `|| true` on the API call means failed clients get admitted with no traffic routing — they connect but have no internet. Removing this and adding retry + error propagation ensures OpenVPN rejects the client cleanly on failure, which is the correct UX (client retries automatically). The PROTO-02 verification confirms HTTP/SOCKS5 stability is maintained.

Output: Fixed shell scripts with proper error handling. Verified DNAT/REDIRECT isolation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-openvpn-throughput/01-RESEARCH.md

@server/deployments/openvpn/client-connect-ovpn.sh
@server/deployments/openvpn/client-disconnect-ovpn.sh
@server/cmd/tunnel/main.go

<interfaces>
<!-- Key code paths the executor needs to understand. -->

From server/deployments/openvpn/client-connect-ovpn.sh (line 15-17):
```sh
wget -q -O - --post-data="{\"username\":\"$username\",\"vpn_ip\":\"$ifconfig_pool_remote_ip\"}" \
  --header="Content-Type: application/json" \
  "$API_URL/internal/openvpn/connect" || true
```
The `|| true` swallows wget failures. OpenVPN 2.4 blocks on client-connect: if the script returns 0, the client is admitted. If it returns non-zero, the client is rejected.

From server/deployments/openvpn/client-disconnect-ovpn.sh (line 15-17):
```sh
wget -q -O - --post-data="{\"username\":\"$username\",\"vpn_ip\":\"$ifconfig_pool_remote_ip\"}" \
  --header="Content-Type: application/json" \
  "$API_URL/internal/openvpn/disconnect" || true
```
Same `|| true` pattern. Less critical (cleanup), but should still log and report failure.

From server/cmd/tunnel/main.go:
- handleOpenVPNClientConnect (line 885): Adds iptables REDIRECT rules using `-A PREROUTING -s <client_ip> -p tcp -j REDIRECT --to-port 12345` — these are per-client-IP rules.
- setupDNAT (line 543): Adds iptables DNAT rules using `-A PREROUTING -p <proto> --dport <port> -j DNAT --to-destination <vpn_ip>:<port>` — these match on external PORT, not source IP.
- Key: REDIRECT rules match on source IP (10.9.0.x). DNAT rules match on destination port. They never conflict. Changing one does not affect the other.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix client-connect-ovpn.sh to reject clients on API failure</name>
  <files>server/deployments/openvpn/client-connect-ovpn.sh, server/deployments/openvpn/client-disconnect-ovpn.sh</files>
  <action>
**Replace `server/deployments/openvpn/client-connect-ovpn.sh` entirely with:**

```sh
#!/bin/sh
# Called by OpenVPN (client-server) when a client connects.
# OpenVPN 2.4 blocks on this script: exit 0 = admit, exit 1 = reject.
#
# Environment variables from OpenVPN:
# - username: the authenticated username (username-as-common-name)
# - ifconfig_pool_remote_ip: assigned VPN IP (10.9.0.x)

if [ -f /etc/openvpn/api_url ]; then
  API_URL=$(cat /etc/openvpn/api_url)
else
  API_URL="${OPENVPN_API_URL:-http://127.0.0.1:8080/api}"
fi

echo "OpenVPN client connected: $username at $ifconfig_pool_remote_ip"

# Notify API to set up transparent proxy mapping + iptables REDIRECT.
# Retry once on failure (covers transient network errors).
# If both attempts fail, exit 1 so OpenVPN rejects the client.
# This is correct: admitting a client without the REDIRECT rule means
# the client connects but has no internet (traffic dropped or unproxied).
MAX_RETRIES=2
attempt=1
while [ "$attempt" -le "$MAX_RETRIES" ]; do
  if wget -q -O - --timeout=5 \
    --post-data="{\"username\":\"$username\",\"vpn_ip\":\"$ifconfig_pool_remote_ip\"}" \
    --header="Content-Type: application/json" \
    "$API_URL/internal/openvpn/connect"; then
    echo "API notified successfully for $username (attempt $attempt)"
    exit 0
  fi
  echo "WARNING: API call failed for $username (attempt $attempt/$MAX_RETRIES)"
  attempt=$((attempt + 1))
  [ "$attempt" -le "$MAX_RETRIES" ] && sleep 1
done

echo "ERROR: Failed to notify API for $username after $MAX_RETRIES attempts — rejecting client"
exit 1
```

Key changes from the original:
1. Removed `|| true` — failures now propagate
2. Added retry loop (2 attempts, 1 second between)
3. Added `--timeout=5` to wget to avoid hanging indefinitely on API unavailability
4. Exit 0 only on success; exit 1 on all-retries-exhausted
5. Added logging for each attempt and final failure

**Replace `server/deployments/openvpn/client-disconnect-ovpn.sh` entirely with:**

```sh
#!/bin/sh
# Called by OpenVPN (client-server) when a client disconnects.
# Exit code does not affect client state (already disconnected),
# but we still fail properly for logging visibility.
#
# Environment variables from OpenVPN:
# - username: the authenticated username
# - ifconfig_pool_remote_ip: the VPN IP that was assigned (10.9.0.x)

if [ -f /etc/openvpn/api_url ]; then
  API_URL=$(cat /etc/openvpn/api_url)
else
  API_URL="${OPENVPN_API_URL:-http://127.0.0.1:8080/api}"
fi

echo "OpenVPN client disconnected: $username at $ifconfig_pool_remote_ip"

if ! wget -q -O - --timeout=5 \
  --post-data="{\"username\":\"$username\",\"vpn_ip\":\"$ifconfig_pool_remote_ip\"}" \
  --header="Content-Type: application/json" \
  "$API_URL/internal/openvpn/disconnect"; then
  echo "WARNING: Failed to notify API of disconnect for $username — iptables cleanup may be stale"
  exit 1
fi

exit 0
```

Key changes from the original:
1. Removed `|| true`
2. Added `--timeout=5` to wget
3. Exit 1 on failure (for logging visibility — OpenVPN ignores disconnect script exit code but log analysis benefits from clear error signals)
  </action>
  <verify>
    <automated>cd server && grep -c "|| true" deployments/openvpn/client-connect-ovpn.sh deployments/openvpn/client-disconnect-ovpn.sh && echo "FAIL: || true still present" || echo "PASS: no || true" && grep -c "exit 1" deployments/openvpn/client-connect-ovpn.sh && grep "MAX_RETRIES" deployments/openvpn/client-connect-ovpn.sh && grep "timeout=5" deployments/openvpn/client-connect-ovpn.sh</automated>
  </verify>
  <done>`|| true` removed from both scripts. client-connect-ovpn.sh has retry logic (2 attempts), wget timeout (5s), and exits 1 on failure (causing OpenVPN to reject the client). client-disconnect-ovpn.sh has wget timeout and exits 1 on failure for log visibility. No client will be admitted without a working transparent proxy mapping.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify DNAT/REDIRECT isolation (PROTO-02)</name>
  <files>server/cmd/tunnel/main.go</files>
  <action>
Fixed client-connect-ovpn.sh error handling (Task 1) and the OpenVPN config tuning (Plan 01-01). Before deploying, verify that HTTP/SOCKS5 DNAT rules are structurally isolated from OpenVPN REDIRECT rules by reviewing the iptables rule management code.

The research identified that PROTO-02 (HTTP/SOCKS5 stability) is satisfied because:
1. DNAT rules match on **destination port** (`--dport`): `iptables -t nat -A PREROUTING -p tcp --dport <ext_port> -j DNAT --to-destination <vpn_ip>:<dev_port>`
2. REDIRECT rules match on **source IP** (`-s`): `iptables -t nat -A PREROUTING -s <client_ip> -p tcp -j REDIRECT --to-port 12345`
3. These are different match criteria — adding/removing one never touches the other
4. The `handleOpenVPNClientConnect` function in `server/cmd/tunnel/main.go` (line 885) only creates/deletes rules with `-s <client_vpn_ip>`, never with `--dport`
5. The `setupDNAT`/`teardownDNAT` functions (lines 543, 569) only create/delete rules with `--dport`, never with `-s 10.9.0.*`
6. `AddMapping`/`RemoveMapping` on the transparent proxy use `sync.RWMutex` — thread-safe

Additionally, the changes made in Plan 01-01 (peekTimeout, sndbuf/rcvbuf, fast-io) only affect OpenVPN server config and the transparent proxy timeout — they do not touch any iptables rules or the DNAT path at all.

**Human verification steps:**
Review the analysis above and confirm:
1. You agree that DNAT (HTTP/SOCKS5) and REDIRECT (OpenVPN) rules use different iptables match criteria and cannot conflict
2. The changes in Plan 01-01 do not modify any iptables rule logic
3. You are confident HTTP/SOCKS5 proxies will remain stable after deploying these changes

If you want extra confidence, after deploying to the server:
- Run `iptables -t nat -L PREROUTING -n --line-numbers` and verify DNAT and REDIRECT rules coexist
- Test an HTTP proxy connection while an OpenVPN client connects/disconnects

Type "approved" to confirm PROTO-02 is satisfied, or describe concerns.
  </action>
  <verify>Human confirms DNAT/REDIRECT rule isolation after reviewing code analysis</verify>
  <done>PROTO-02 confirmed: HTTP/SOCKS5 DNAT rules are structurally isolated from OpenVPN REDIRECT rules. Changes to OpenVPN config and shell scripts do not affect HTTP/SOCKS5 proxy stability.</done>
</task>

</tasks>

<verification>
1. `grep "|| true" server/deployments/openvpn/client-connect-ovpn.sh` returns no matches
2. `grep "|| true" server/deployments/openvpn/client-disconnect-ovpn.sh` returns no matches
3. `grep "exit 1" server/deployments/openvpn/client-connect-ovpn.sh` returns at least 1 match
4. `grep "MAX_RETRIES" server/deployments/openvpn/client-connect-ovpn.sh` returns at least 1 match
5. `grep "timeout=5" server/deployments/openvpn/client-connect-ovpn.sh` returns at least 1 match
6. PROTO-02 checkpoint confirmed by human review of DNAT/REDIRECT isolation
</verification>

<success_criteria>
- client-connect-ovpn.sh rejects clients (exit 1) when API notification fails — no more silent admission without routing
- Retry logic covers transient network errors (2 attempts)
- wget has a 5-second timeout to prevent indefinite hangs
- client-disconnect-ovpn.sh fails visibly on error for log analysis
- PROTO-02 confirmed: HTTP/SOCKS5 DNAT rules structurally isolated from OpenVPN REDIRECT rules
</success_criteria>

<output>
After completion, create `.planning/phases/01-openvpn-throughput/01-02-SUMMARY.md`
</output>
