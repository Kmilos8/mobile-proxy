---
phase: 04-bug-fixes-and-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/components/devices/DeviceTable.tsx
  - dashboard/src/components/connections/ConnectionTable.tsx
autonomous: true
requirements: [DASH-02]

must_haves:
  truths:
    - "The devices page has a search bar that filters devices by name"
    - "The device table shows an auto-rotation column indicating whether auto-rotation is enabled on each device"
    - "Every connection has a visible connection ID assigned at creation, shown in the connection table"
  artifacts:
    - path: "dashboard/src/components/devices/DeviceTable.tsx"
      provides: "Search bar filtering by device name and auto-rotation column"
      contains: "searchQuery"
    - path: "dashboard/src/components/connections/ConnectionTable.tsx"
      provides: "Connection ID column with truncated UUID and copy button"
      contains: "conn.id.slice"
  key_links:
    - from: "dashboard/src/components/devices/DeviceTable.tsx"
      to: "@/lib/api Device interface"
      via: "auto_rotate_minutes field already in Device type"
      pattern: "auto_rotate_minutes"
    - from: "dashboard/src/components/connections/ConnectionTable.tsx"
      to: "@/lib/api ProxyConnection interface"
      via: "id field already in ProxyConnection type"
      pattern: "conn\\.id"
---

<objective>
Add three dashboard UI improvements: device search bar, auto-rotation column in the device table, and connection ID column in the connection table.

Purpose: Complete DASH-02 dashboard polish items from v1.0 milestone audit. These are pure frontend additions using data already returned by the API.
Output: DeviceTable with search input and auto-rotation column; ConnectionTable with connection ID column (desktop + mobile).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-bug-fixes-and-polish/04-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From dashboard/src/lib/api.ts:
```typescript
export interface Device {
  id: string
  name: string
  status: string
  cellular_ip: string
  auto_rotate_minutes: number  // Already available — 0 = off, >0 = interval
  // ... other fields
}

export interface ProxyConnection {
  id: string  // UUID — already returned by API
  proxy_type: 'http' | 'socks5' | 'openvpn'
  username: string
  // ... other fields
}
```

From dashboard/src/components/devices/DeviceTable.tsx:
```typescript
type SortKey = 'name' | 'status' | 'cellular_ip' | 'connections'
type SortDir = 'asc' | 'desc'
type StatusFilter = 'all' | 'online' | 'offline'

interface DeviceTableProps {
  devices: Device[]
  connectionCounts: Record<string, number>
}
```

From dashboard/src/components/connections/ConnectionTable.tsx:
```typescript
interface ConnectionTableProps {
  connections: ProxyConnection[]
  device: Device
  serverHost: string
  onDelete: (id: string) => void
  onRefresh: () => void
}

// CopyButton is an inline sub-component using copiedKey state with 2s timeout
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search bar and auto-rotation column to DeviceTable</name>
  <files>dashboard/src/components/devices/DeviceTable.tsx</files>
  <action>
Modify DeviceTable.tsx to add a search input and auto-rotation column. All changes are within this single file.

**1. Add Search icon import:**
Add `Search` to the lucide-react import (alongside ArrowUp, ArrowDown, ChevronsUpDown).

**2. Add searchQuery state:**
Add `const [searchQuery, setSearchQuery] = useState('')` alongside the existing sortKey/sortDir/statusFilter states.

**3. Add search input in the controls row:**
In the filter controls area (where the All/Online/Offline buttons are), add a search input positioned to the right (using `ml-auto`):

```tsx
<div className="relative ml-auto">
  <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-500 pointer-events-none" />
  <input
    type="text"
    placeholder="Search devices..."
    value={searchQuery}
    onChange={(e) => setSearchQuery(e.target.value)}
    className="pl-8 pr-3 py-1 bg-zinc-800 border border-zinc-700 text-white text-xs rounded focus:outline-none focus:border-brand-500"
  />
</div>
```

**4. Update filtered array to include search:**
Change the filter logic to check name match before status filter:

```typescript
const filtered = devices.filter(d => {
  if (searchQuery && !(d.name || '').toLowerCase().includes(searchQuery.toLowerCase())) return false
  if (statusFilter === 'online') return d.status === 'online'
  if (statusFilter === 'offline') return d.status !== 'online'
  return true
})
```

**5. Extend SortKey type:**
Change: `type SortKey = 'name' | 'status' | 'cellular_ip' | 'connections'`
To: `type SortKey = 'name' | 'status' | 'cellular_ip' | 'auto_rotate' | 'connections'`

**6. Add Auto-Rotate table header:**
After the IP column header (which has `hidden md:table-cell`), add:

```tsx
<TableHead
  className="text-zinc-400 hover:text-white cursor-pointer select-none h-10 px-4 hidden md:table-cell"
  onClick={() => handleSort('auto_rotate')}
>
  Auto-Rotate <SortIcon column="auto_rotate" sortKey={sortKey} sortDir={sortDir} />
</TableHead>
```

**7. Add Auto-Rotate table cell:**
After the IP cell in each row (which has `hidden md:table-cell`), add:

```tsx
<TableCell className="px-4 py-3 text-xs hidden md:table-cell">
  {d.auto_rotate_minutes > 0
    ? <span className="text-emerald-400">every {d.auto_rotate_minutes}m</span>
    : <span className="text-zinc-600">&mdash;</span>}
</TableCell>
```

**8. Add auto_rotate to sort logic:**
In the sorted array sort function, add a case for 'auto_rotate':
```typescript
case 'auto_rotate':
  cmp = (a.auto_rotate_minutes || 0) - (b.auto_rotate_minutes || 0)
  break
```

**9. Update colSpan in empty state:**
Find the `colSpan` in the empty state TableCell (currently 4 or 5) and increment it by 1 to account for the new Auto-Rotate column.

IMPORTANT: Do not remove or rewrite existing columns or functionality. Only ADD the search input, filter logic, and auto-rotation column.
  </action>
  <verify>
    <automated>cd dashboard && npx tsc --noEmit 2>&1 | head -20 && echo "TSC OK"</automated>
  </verify>
  <done>DeviceTable has a search input filtering by name, an Auto-Rotate sortable column showing "every Xm" or dash, and the colSpan is correct for the empty state. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add connection ID column to ConnectionTable</name>
  <files>dashboard/src/components/connections/ConnectionTable.tsx</files>
  <action>
Add a connection ID column to the ConnectionTable component, both in the desktop table view and the mobile card view.

**Desktop table — header:**
Add an "ID" column header as the FIRST column (before "Type"):

```tsx
<TableHead className="text-xs font-medium text-zinc-500">ID</TableHead>
```

**Desktop table — cell:**
Add an ID cell as the first cell in each table row (before the Type badge cell):

```tsx
<TableCell className="font-mono text-xs text-zinc-500">
  {conn.id.slice(0, 8)}
  <CopyButton text={conn.id} copyKey={`${conn.id}-id`} />
</TableCell>
```

Where `CopyButton` is the existing inline copy button sub-component already used in ConnectionTable (uses the copiedKey state pattern with 2s timeout). If CopyButton is defined as a local function within ConnectionTable, just use it. If it's done inline, follow the same pattern — a small button with `Copy` icon that copies `conn.id` to clipboard and shows a 2s "Copied!" feedback.

**Mobile card view:**
In the mobile card layout (the stacked card layout below `md:hidden` or used as alternative), add an ID row in the details block:

```tsx
<div className="flex items-center justify-between">
  <span className="text-zinc-500">ID</span>
  <span className="font-mono text-xs text-zinc-400 flex items-center gap-1">
    {conn.id.slice(0, 8)}
    {/* copy button for mobile card */}
  </span>
</div>
```

**Display format:** `conn.id.slice(0, 8)` — show first 8 characters of the UUID in monospace. The copy button copies the FULL UUID (`conn.id`), not just the truncated prefix.

IMPORTANT: Study the existing CopyButton/copy pattern in ConnectionTable before implementing. Follow the exact same pattern (copiedKey state, 2s timeout, Copy/Check icon swap). Do not add a new copy mechanism — reuse the existing one.
  </action>
  <verify>
    <automated>cd dashboard && npx tsc --noEmit 2>&1 | head -20 && echo "TSC OK"</automated>
  </verify>
  <done>ConnectionTable shows truncated connection ID (8 chars) with copy-full-UUID button in both desktop table and mobile card layouts. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `cd dashboard && npx tsc --noEmit` — TypeScript compiles without errors
2. Code review: DeviceTable.tsx has `searchQuery` state and search input with Search icon
3. Code review: DeviceTable.tsx has Auto-Rotate column header and cell with `auto_rotate_minutes` display
4. Code review: DeviceTable.tsx colSpan updated for empty state
5. Code review: ConnectionTable.tsx has ID column header and cell with `conn.id.slice(0, 8)` and copy button
6. Code review: ConnectionTable.tsx mobile card view has ID row
</verification>

<success_criteria>
- Device search: Input field filters devices by name (case-insensitive substring match)
- Auto-rotation column: Shows "every Xm" in emerald for active rotation, dash for disabled, sortable
- Connection ID: First 8 chars of UUID in monospace, full UUID on copy, visible in both desktop and mobile layouts
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-bug-fixes-and-polish/04-02-SUMMARY.md`
</output>
