---
phase: 01-openvpn-throughput
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/internal/transparentproxy/proxy.go
  - server/deployments/openvpn/client-server.conf
  - server/internal/api/handler/openvpn_handler.go
autonomous: true
requirements:
  - PROTO-01

must_haves:
  truths:
    - "peekTimeout is 200ms or less, not 2 seconds"
    - "OpenVPN server config uses sndbuf 0 / rcvbuf 0 (OS autotuning) instead of fixed 524288"
    - "Generated .ovpn files use sndbuf 0 / rcvbuf 0 instead of fixed 524288"
    - "OpenVPN server config has fast-io directive for reduced CPU overhead"
  artifacts:
    - path: "server/internal/transparentproxy/proxy.go"
      provides: "Transparent proxy with reduced peekTimeout"
      contains: "200 * time.Millisecond"
    - path: "server/deployments/openvpn/client-server.conf"
      provides: "OpenVPN server config with OS buffer autotuning and fast-io"
      contains: "sndbuf 0"
    - path: "server/internal/api/handler/openvpn_handler.go"
      provides: "DownloadOVPN generating .ovpn with sndbuf 0 / rcvbuf 0"
      contains: "sndbuf 0"
  key_links:
    - from: "server/deployments/openvpn/client-server.conf"
      to: "client .ovpn configs"
      via: "push directives override client-side values"
      pattern: 'push "sndbuf 0"'
    - from: "server/internal/api/handler/openvpn_handler.go"
      to: "downloaded .ovpn files"
      via: "DownloadOVPN writes sndbuf/rcvbuf into config"
      pattern: 'WriteString\("sndbuf 0'
---

<objective>
Apply targeted OpenVPN performance tuning: reduce transparent proxy peekTimeout from 2s to 200ms, switch sndbuf/rcvbuf from fixed 512KB to OS autotuning (value 0), and add fast-io to the server config.

Purpose: These three changes address the two highest-confidence bottlenecks identified in research — peekTimeout adds up to 2 seconds latency per new connection (kills speed tests and page loads), and fixed sndbuf/rcvbuf prevents Linux TCP autotuning from adapting buffers (documented 5 Mbps to 60 Mbps improvement in community testing).

Output: Modified proxy.go, client-server.conf, and openvpn_handler.go ready for deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-openvpn-throughput/01-RESEARCH.md

@server/internal/transparentproxy/proxy.go
@server/deployments/openvpn/client-server.conf
@server/internal/api/handler/openvpn_handler.go

<interfaces>
<!-- Key constants and functions the executor needs. Extracted from codebase. -->

From server/internal/transparentproxy/proxy.go (line 29):
```go
peekTimeout    = 2 * time.Second  // time to wait for initial client data
```
This is the constant to change to 200ms.

From server/deployments/openvpn/client-server.conf (lines 48-51):
```
sndbuf 524288
rcvbuf 524288
push "sndbuf 524288"
push "rcvbuf 524288"
```
All four lines must change to 0.

From server/internal/api/handler/openvpn_handler.go (lines 217-218):
```go
ovpn.WriteString("sndbuf 524288\n")
ovpn.WriteString("rcvbuf 524288\n")
```
Both lines must change to 0.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce peekTimeout from 2s to 200ms in transparent proxy</name>
  <files>server/internal/transparentproxy/proxy.go</files>
  <action>
Change the `peekTimeout` constant on line 29 from `2 * time.Second` to `200 * time.Millisecond`.

Update the comment to explain why 200ms:
```go
peekTimeout    = 200 * time.Millisecond // time to wait for initial client data (TLS ClientHello arrives in <10ms; 200ms covers slow clients without blocking speed tests)
```

Do NOT change any other constants (connectTimeout, idleTimeout, maxRetries, copyBufSize, peekSize). They are correct.

Do NOT change the peek/fallback logic in handleConn — the existing fallback to raw IP routing (`connectAddr = origDst`) when no data arrives is correct behavior for the 200ms timeout.
  </action>
  <verify>
    <automated>cd server && grep -n "peekTimeout" internal/transparentproxy/proxy.go | grep "200 \* time.Millisecond"</automated>
  </verify>
  <done>peekTimeout is 200 * time.Millisecond. No other constants or logic changed. The transparent proxy will now wait at most 200ms for client data instead of 2 seconds, eliminating the per-connection latency penalty that blocks speed tests.</done>
</task>

<task type="auto">
  <name>Task 2: Switch sndbuf/rcvbuf to OS autotuning and add fast-io</name>
  <files>server/deployments/openvpn/client-server.conf, server/internal/api/handler/openvpn_handler.go</files>
  <action>
**In `server/deployments/openvpn/client-server.conf`:**

1. Replace the performance tuning block (lines 48-51):
```
sndbuf 524288
rcvbuf 524288
push "sndbuf 524288"
push "rcvbuf 524288"
```
With:
```
sndbuf 0
rcvbuf 0
push "sndbuf 0"
push "rcvbuf 0"
```

2. Add `fast-io` on a new line immediately after `txqueuelen 1000` (line 54). Add a comment:
```
fast-io  # skip poll/select before UDP write (5-10% CPU reduction, UDP only)
```

Do NOT change mssfix (1400), tun-mtu (1500), or txqueuelen (1000) — they are correct per research.
Do NOT add compression (lz4/lzo) — current no-compression config is correct for HTTPS-dominant traffic.

**In `server/internal/api/handler/openvpn_handler.go`:**

1. In the `DownloadOVPN` function, replace lines 217-218:
```go
ovpn.WriteString("sndbuf 524288\n")
ovpn.WriteString("rcvbuf 524288\n")
```
With:
```go
ovpn.WriteString("sndbuf 0\n")
ovpn.WriteString("rcvbuf 0\n")
```

This ensures both server config AND generated client .ovpn files use OS autotuning. The `push "sndbuf 0"` directives on the server override client values, but matching them in the .ovpn avoids confusion and covers clients that connect before config push takes effect.
  </action>
  <verify>
    <automated>cd server && grep -c "sndbuf 0" deployments/openvpn/client-server.conf && grep -c "rcvbuf 0" deployments/openvpn/client-server.conf && grep "fast-io" deployments/openvpn/client-server.conf && grep "sndbuf 0" internal/api/handler/openvpn_handler.go && grep "rcvbuf 0" internal/api/handler/openvpn_handler.go</automated>
  </verify>
  <done>sndbuf/rcvbuf set to 0 in both client-server.conf (4 lines: server + push) and openvpn_handler.go (2 lines: .ovpn generation). fast-io added to server config. No 524288 values remain anywhere. OS TCP autotuning is now enabled for OpenVPN connections.</done>
</task>

</tasks>

<verification>
1. `grep -r "524288" server/` returns no matches (all fixed buffer values removed)
2. `grep "peekTimeout" server/internal/transparentproxy/proxy.go` shows 200ms
3. `grep "sndbuf 0" server/deployments/openvpn/client-server.conf` shows 2 matches (sndbuf + push)
4. `grep "rcvbuf 0" server/deployments/openvpn/client-server.conf` shows 2 matches (rcvbuf + push)
5. `grep "fast-io" server/deployments/openvpn/client-server.conf` shows 1 match
6. `grep "sndbuf 0" server/internal/api/handler/openvpn_handler.go` shows 1 match
7. `grep "rcvbuf 0" server/internal/api/handler/openvpn_handler.go` shows 1 match
</verification>

<success_criteria>
- peekTimeout reduced to 200ms (from 2s) — eliminates per-connection latency penalty
- sndbuf/rcvbuf set to 0 everywhere (server config, push directives, .ovpn generator) — enables OS TCP autotuning
- fast-io added to server config — reduces CPU overhead on UDP writes
- No other OpenVPN settings changed (mssfix, tun-mtu, cipher, keepalive all preserved)
- No compression added
</success_criteria>

<output>
After completion, create `.planning/phases/01-openvpn-throughput/01-01-SUMMARY.md`
</output>
