---
phase: 05-auth-foundation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - dashboard/src/app/login/page.tsx
  - dashboard/src/app/signup/page.tsx
  - dashboard/src/app/signup/verify/page.tsx
  - dashboard/src/app/verify-email/page.tsx
  - dashboard/src/app/forgot-password/page.tsx
  - dashboard/src/app/reset-password/page.tsx
  - dashboard/src/lib/api.ts
  - dashboard/package.json
autonomous: false
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05]
user_setup:
  - service: cloudflare-turnstile
    why: "Bot protection on signup/login/forgot-password forms"
    env_vars:
      - name: NEXT_PUBLIC_TURNSTILE_SITE_KEY
        source: "Cloudflare Dashboard -> Turnstile -> Site -> Site Key"
    dashboard_config:
      - task: "Create Turnstile widget"
        location: "Cloudflare Dashboard -> Turnstile -> Add Site"
  - service: google-oauth
    why: "Google social login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
    dashboard_config:
      - task: "Create OAuth consent screen and credentials"
        location: "Google Cloud Console -> APIs & Services -> OAuth consent screen"
      - task: "Add authorized redirect URI"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client -> Authorized redirect URIs"
  - service: resend
    why: "Transactional email delivery (verification, password reset)"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
    dashboard_config:
      - task: "Verify sending domain"
        location: "Resend Dashboard -> Domains -> Add Domain -> Configure DNS records"

must_haves:
  truths:
    - "Login page has Google sign-in button, Forgot password link, and Sign up link"
    - "Signup page has email/password fields, Google button, Turnstile widget, and link to login"
    - "After signup, user sees 'Check your email' page with resend option"
    - "Clicking verification link opens a confirmation page with Verify button (two-step)"
    - "Forgot password page accepts email and shows confirmation message"
    - "Reset password page accepts new password + confirmation and redirects to login on success"
    - "Turnstile widget appears on signup, login, and forgot-password forms"
    - "Google OAuth callback stores token and redirects to dashboard"
  artifacts:
    - path: "dashboard/src/app/login/page.tsx"
      provides: "Extended login page with Google button, forgot password link, signup link, Turnstile"
      contains: "Turnstile"
    - path: "dashboard/src/app/signup/page.tsx"
      provides: "Customer signup form"
      contains: "signup"
    - path: "dashboard/src/app/signup/verify/page.tsx"
      provides: "Check your email confirmation page"
      contains: "verify"
    - path: "dashboard/src/app/verify-email/page.tsx"
      provides: "Two-step email verification page (GET shows button, POST confirms)"
      contains: "verify-email"
    - path: "dashboard/src/app/forgot-password/page.tsx"
      provides: "Enter email form for password reset"
      contains: "forgot-password"
    - path: "dashboard/src/app/reset-password/page.tsx"
      provides: "Set new password form"
      contains: "reset-password"
    - path: "dashboard/src/lib/api.ts"
      provides: "Customer auth API client functions"
      contains: "customerAuth"
  key_links:
    - from: "dashboard/src/app/signup/page.tsx"
      to: "/api/auth/customer/signup"
      via: "api.customerAuth.signup call"
      pattern: "customerAuth\\.signup"
    - from: "dashboard/src/app/login/page.tsx"
      to: "/api/auth/customer/login"
      via: "customer login API call"
      pattern: "customerAuth"
    - from: "dashboard/src/app/verify-email/page.tsx"
      to: "/api/auth/customer/verify-email"
      via: "GET check + POST confirm"
      pattern: "verify-email"
    - from: "dashboard/src/app/reset-password/page.tsx"
      to: "/api/auth/customer/reset-password"
      via: "reset password API call"
      pattern: "reset-password"
---

<objective>
Build all customer-facing frontend auth pages and integrate Turnstile bot protection.

Purpose: Customers need UI for signup, login (with Google), email verification, and password reset. The backend endpoints (Plan 02) are ready; this plan creates the Next.js pages that call them. This completes the full auth flow end-to-end.

Output: Six frontend pages (login extension, signup, verify confirmation, verify-email, forgot-password, reset-password), Turnstile integration, and API client extensions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-foundation/05-CONTEXT.md
@.planning/phases/05-auth-foundation/05-RESEARCH.md
@.planning/phases/05-auth-foundation/05-01-SUMMARY.md
@.planning/phases/05-auth-foundation/05-02-SUMMARY.md

<interfaces>
<!-- Existing login page design (from dashboard/src/app/login/page.tsx) -->
<!-- Executor must match this visual style for all new pages -->

Login page design tokens:
- Outer: min-h-screen flex items-center justify-center, radial glow bg-brand-500/5
- Card: bg-zinc-900 p-8 rounded-xl border border-zinc-800 w-full max-w-md shadow-glow-sm
- Logo: Image src="/logo.svg" width=48 height=48, PocketProxy text with brand-400/brand-500
- Input: bg-zinc-800 border border-zinc-700 rounded text-white focus:border-brand-500
- Button: bg-brand-600 hover:bg-brand-500 disabled:bg-brand-800 text-white rounded font-medium
- Error: bg-red-900/50 border border-red-800 text-red-200
- Label: text-sm text-zinc-400

From dashboard/src/lib/api.ts (existing pattern):
```typescript
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api'
async function request<T>(path: string, options: RequestOptions = {}): Promise<T>
export const api = {
  auth: { login: (email, password) => request('/auth/login', ...) },
  // ... other namespaces
}
```

From dashboard/src/lib/auth.ts (existing):
```typescript
export function setAuth(token: string, user: { id: string; email: string; name: string; role: string })
export function getToken(): string | null
export function clearAuth()
```

Backend endpoints (from Plan 02):
- POST /api/auth/customer/signup -- body: {email, password, turnstile_token} -> 201 {message}
- POST /api/auth/customer/login -- body: {email, password, turnstile_token} -> 200 {token, customer}
- GET  /api/auth/customer/verify-email?token=X -> 200 {valid: bool}
- POST /api/auth/customer/verify-email -- body: {token} -> 200 {token, customer}
- POST /api/auth/customer/resend-verification -- body: {email} -> 200 {message}
- POST /api/auth/customer/forgot-password -- body: {email, turnstile_token} -> 200 {message}
- POST /api/auth/customer/reset-password -- body: {token, password, confirm_password} -> 200 {message}
- GET  /api/auth/customer/google -> 307 redirect to Google
- GET  /api/auth/customer/google/callback -> 307 redirect to /login?token=X&google=true
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Turnstile package, extend API client, build signup + login pages</name>
  <files>
    dashboard/package.json
    dashboard/src/lib/api.ts
    dashboard/src/app/login/page.tsx
    dashboard/src/app/signup/page.tsx
    dashboard/src/app/signup/verify/page.tsx
  </files>
  <action>
    **1. Install @marsidev/react-turnstile:**
    ```bash
    cd dashboard && npm install @marsidev/react-turnstile
    ```

    **2. Add customer auth API methods to `dashboard/src/lib/api.ts`:**

    Add a `customerAuth` namespace to the existing `api` object:
    ```typescript
    customerAuth: {
      signup: (email: string, password: string, turnstileToken: string) =>
        request<{ message: string }>('/auth/customer/signup', {
          method: 'POST',
          body: { email, password, turnstile_token: turnstileToken }
        }),
      login: (email: string, password: string, turnstileToken: string) =>
        request<{ token: string; customer: Customer }>('/auth/customer/login', {
          method: 'POST',
          body: { email, password, turnstile_token: turnstileToken }
        }),
      verifyEmailCheck: (token: string) =>
        request<{ valid: boolean; reason?: string }>(`/auth/customer/verify-email?token=${encodeURIComponent(token)}`),
      verifyEmail: (token: string) =>
        request<{ token: string; customer: Customer }>('/auth/customer/verify-email', {
          method: 'POST',
          body: { token }
        }),
      resendVerification: (email: string) =>
        request<{ message: string }>('/auth/customer/resend-verification', {
          method: 'POST',
          body: { email }
        }),
      forgotPassword: (email: string, turnstileToken: string) =>
        request<{ message: string }>('/auth/customer/forgot-password', {
          method: 'POST',
          body: { email, turnstile_token: turnstileToken }
        }),
      resetPassword: (token: string, password: string, confirmPassword: string) =>
        request<{ message: string }>('/auth/customer/reset-password', {
          method: 'POST',
          body: { token, password, confirm_password: confirmPassword }
        }),
    },
    ```

    **3. Update `dashboard/src/app/login/page.tsx`:**

    Preserve the current design. Add these elements:

    a) Import Turnstile: `import { Turnstile } from '@marsidev/react-turnstile'`
    b) Add `turnstileToken` state (useState<string>(''))
    c) Add Turnstile widget below the password field, above the Sign In button:
       ```tsx
       {process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY && (
         <Turnstile
           siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY}
           onSuccess={setTurnstileToken}
           onError={() => setTurnstileToken('')}
           onExpire={() => setTurnstileToken('')}
         />
       )}
       ```
       The conditional render ensures the widget only appears when the env var is set (graceful dev mode).

    d) Add a visual divider after the Sign In button:
       ```tsx
       <div className="relative my-4">
         <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-zinc-700" /></div>
         <div className="relative flex justify-center text-xs"><span className="bg-zinc-900 px-2 text-zinc-500">or</span></div>
       </div>
       ```

    e) Add Google sign-in button after the divider:
       ```tsx
       <a
         href={`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api'}/auth/customer/google`}
         className="w-full py-2 bg-white hover:bg-gray-100 text-gray-800 rounded font-medium flex items-center justify-center gap-2 border border-gray-300"
       >
         <svg className="w-5 h-5" viewBox="0 0 24 24">
           {/* Google "G" logo SVG path */}
         </svg>
         Sign in with Google
       </a>
       ```
       Use the standard Google "G" logo SVG (4 color paths: blue, red, yellow, green). The button should be a white background with dark text per Google branding guidelines.

    f) Add "Forgot password?" link below the form (before the card closes):
       ```tsx
       <div className="mt-4 text-center text-sm">
         <a href="/forgot-password" className="text-brand-400 hover:text-brand-300">Forgot password?</a>
       </div>
       ```

    g) Add "Don't have an account? Sign up" link:
       ```tsx
       <div className="mt-2 text-center text-sm text-zinc-400">
         Don't have an account?{' '}
         <a href="/signup" className="text-brand-400 hover:text-brand-300">Sign up</a>
       </div>
       ```

    h) Handle Google OAuth callback: Add useEffect that checks URL search params for `token` and `google=true`. If present, call `setAuth(token, customer)` and redirect to `/devices`. Read the token from the query param set by the backend Google callback redirect.
       ```tsx
       useEffect(() => {
         const params = new URLSearchParams(window.location.search)
         const token = params.get('token')
         const isGoogle = params.get('google')
         if (token && isGoogle) {
           // Decode JWT payload to extract user info
           try {
             const payload = JSON.parse(atob(token.split('.')[1]))
             setAuth(token, { id: payload.user_id, email: payload.email, name: payload.email.split('@')[0], role: payload.role })
             router.push('/devices')
           } catch { /* ignore invalid tokens */ }
         }
       }, [])
       ```

    i) The login form currently calls `api.auth.login`. Keep this for admin/operator login. Add logic: the login page should FIRST try `api.customerAuth.login` (passing turnstileToken), and if that returns a 401 with no "email_not_verified" code, fall back to the existing `api.auth.login` (operator login, no turnstile token needed since operators don't have turnstile). Actually, a cleaner approach: since operators and customers are different tables, keep the EXISTING admin login call as-is but add customer login. The simplest approach: try customer login first; if it fails with 401, try admin login as fallback. This preserves backward compatibility for the single admin user.

       Alternatively (even simpler): Keep the existing `api.auth.login` call as the primary. Add customer login as a separate path. Since the user decision says "keep current layout", maintain `api.auth.login` for the primary form. For customer login, the frontend just needs to call `api.customerAuth.login` with the turnstile token. Use a single form that tries `api.customerAuth.login` first, then falls back to `api.auth.login` (without turnstile) if the customer login returns 401.

       Handle the specific "email_not_verified" response (403 with code "email_not_verified"): show "Please verify your email first" message with a "Resend verification email" button that calls `api.customerAuth.resendVerification(email)`.

    **4. Create `dashboard/src/app/signup/page.tsx`:**

    Same visual style as login page (centered card, radial glow, PocketProxy logo).

    Elements:
    - PocketProxy logo and title (same as login)
    - "Create Account" heading
    - Email input field
    - Password input field (label: "Password (min. 8 characters)")
    - Turnstile widget (same conditional render as login)
    - "Create Account" submit button (brand-600 style)
    - Visual divider ("or")
    - "Sign up with Google" button (same Google button style as login, same href)
    - "Already have an account? Log in" link at bottom (links to /login)
    - Error display (same red box style as login)

    Form submission:
    - Validate password >= 8 chars client-side
    - Call `api.customerAuth.signup(email, password, turnstileToken)`
    - On success (201), redirect to `/signup/verify?email={encodeURIComponent(email)}`
    - On 409 conflict, show "An account with this email already exists"
    - On other errors, show error message

    **5. Create `dashboard/src/app/signup/verify/page.tsx`:**

    "Check your email" confirmation page. Same visual style (centered card).

    Elements:
    - PocketProxy logo
    - Mail icon (use a simple SVG envelope icon)
    - "Check your email" heading
    - Text: "We sent a verification link to {email}. Click the link in the email to verify your account."
    - "Resend verification email" button (secondary style: border border-zinc-700 hover:bg-zinc-800)
    - "Back to login" link
    - Success/error message for resend action

    Read `email` from URL search params. Resend button calls `api.customerAuth.resendVerification(email)`. Show "Verification email sent!" on success. Disable resend button for 60 seconds after each send (prevent spam).
  </action>
  <verify>
    Run `cd dashboard && npm run build` to confirm all pages compile. Check that `@marsidev/react-turnstile` is in package.json dependencies.
  </verify>
  <done>
    Login page extended with Google button (standard Google "G" branding), "Forgot password?" link, "Sign up" link, Turnstile widget, and Google OAuth callback handling. Signup page created with email/password fields, Turnstile, Google button, and proper validation. "Check your email" page shows after signup with resend option. API client has all customerAuth methods. All pages use consistent visual style matching existing login page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify-email, forgot-password, and reset-password pages</name>
  <files>
    dashboard/src/app/verify-email/page.tsx
    dashboard/src/app/forgot-password/page.tsx
    dashboard/src/app/reset-password/page.tsx
  </files>
  <action>
    **1. Create `dashboard/src/app/verify-email/page.tsx`:**

    Two-step email verification page (prevents corporate email scanners from consuming the token).

    Same visual style (centered card, radial glow, PocketProxy logo).

    Behavior:
    - Read `token` from URL search params
    - On mount (useEffect), call `api.customerAuth.verifyEmailCheck(token)` (GET) to check token validity
    - Show loading state while checking

    States:
    a) **Loading**: "Checking verification link..." with a spinner
    b) **Valid token**: Show "Verify your email" heading, text "Click the button below to verify your email address", prominent "Verify Email" button (brand-600). When clicked, call `api.customerAuth.verifyEmail(token)` (POST). On success, store JWT via `setAuth(response.token, ...)` and redirect to `/devices` (auto-login after verification).
    c) **Invalid/expired token**: Show "Verification link expired" heading, text "This link has expired or has already been used.", "Back to login" link.
    d) **No token in URL**: Show "Invalid verification link" with "Back to login" link.

    **2. Create `dashboard/src/app/forgot-password/page.tsx`:**

    Same visual style (centered card).

    Elements:
    - PocketProxy logo
    - "Reset your password" heading
    - Text: "Enter the email address associated with your account"
    - Email input field
    - Turnstile widget (conditional render)
    - "Send reset link" submit button (brand-600)
    - "Back to login" link

    States:
    a) **Form**: Default state with email input
    b) **Submitted**: Show "Check your email" message -- "If an account exists with that email, we sent a password reset link. The link expires in 24 hours." with "Back to login" link. Do NOT reveal whether the email exists in the system (prevent enumeration).

    Form submission: Call `api.customerAuth.forgotPassword(email, turnstileToken)`. Always transition to "submitted" state on 200 (backend always returns 200 regardless of email existence).

    **3. Create `dashboard/src/app/reset-password/page.tsx`:**

    Same visual style (centered card).

    Elements:
    - PocketProxy logo
    - "Set new password" heading
    - Password input field (label: "New password (min. 8 characters)")
    - Confirm password input field (label: "Confirm new password")
    - "Reset password" submit button (brand-600)
    - Error display

    Read `token` from URL search params.

    Client-side validation:
    - Password >= 8 chars
    - Password === confirm password (show error "Passwords do not match" if different)

    Form submission: Call `api.customerAuth.resetPassword(token, password, confirmPassword)`.

    States:
    a) **Form**: Default with password fields
    b) **Success**: Show "Password updated" heading, text "Your password has been successfully reset.", "Sign in" link/button that goes to `/login`. Per user decision: redirect to login with "Password updated" banner. Implement this as: redirect to `/login?message=password_updated` and handle in login page (show a green success banner "Password updated successfully" when this query param is present, clear it after display).
    c) **Error**: Show inline error. For expired/invalid token, show "This reset link has expired or has already been used. Please request a new one." with link to `/forgot-password`.
    d) **No token in URL**: Show "Invalid reset link" with link to `/forgot-password`.

    **4. Update login page to handle password_updated message:**
    Add to the login page's useEffect: check for `message=password_updated` query param. If present, show a green success banner `bg-green-900/50 border border-green-800 text-green-200` with text "Password updated successfully. Please sign in with your new password." Clear the URL param after displaying.
  </action>
  <verify>
    Run `cd dashboard && npm run build` to confirm all pages compile without errors. Verify all 6 auth pages exist by listing: `ls dashboard/src/app/signup/ dashboard/src/app/verify-email/ dashboard/src/app/forgot-password/ dashboard/src/app/reset-password/`.
  </verify>
  <done>
    Verify-email page implements two-step flow (GET checks token validity, POST consumes token with auto-login). Forgot-password page collects email with Turnstile and shows generic confirmation (prevents enumeration). Reset-password page accepts new password with confirmation, validates match, redirects to login with success banner. Login page handles password_updated query param. All pages match existing visual design system. `npm run build` succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow end-to-end</name>
  <files>
    dashboard/src/app/login/page.tsx
    dashboard/src/app/signup/page.tsx
  </files>
  <action>
    Human verifies the complete customer authentication system built in Tasks 1 and 2: signup with email/password, Google OAuth, email verification (two-step), password reset, and Turnstile bot protection. Both backend Go API and frontend Next.js pages are tested end-to-end.
  </action>
  <verify>
    1. Visit the login page -- confirm "Sign in with Google" button, "Forgot password?" link, "Sign up" link, and Turnstile widget are visible
    2. Click "Sign up" -- confirm signup page with email/password fields, Google button, Turnstile widget, and "Already have an account?" link
    3. Create a test account with email/password -- confirm redirect to "Check your email" page
    4. If Resend is configured: check email inbox for verification email with link
    5. Click verification link -- confirm two-step page (shows "Verify Email" button, does NOT auto-verify on page load)
    6. Click "Verify Email" -- confirm auto-login and redirect to dashboard
    7. Log out, click "Forgot password?" -- confirm email input page
    8. Submit email -- confirm generic "check your email" message (no email existence leak)
    9. If Resend configured: click reset link in email -- confirm "Set new password" page
    10. Set new password -- confirm redirect to login with "Password updated" green banner
    11. Test Google sign-in (if Google OAuth configured) -- confirm redirect flow works

    Note: If external services (Resend, Google OAuth, Turnstile) are not yet configured, verify:
    - Pages render correctly without Turnstile (widget hidden when env var not set)
    - Signup/login work without Turnstile (backend skips verification when secret key empty)
    - Email service logs email content to console when API key is empty
  </verify>
  <done>User has visually confirmed all auth pages render correctly, forms submit to the correct endpoints, and the complete signup/verification/login/reset flow works end-to-end.</done>
</task>

</tasks>

<verification>
- `cd dashboard && npm run build` passes without errors
- All 6 auth page directories exist under dashboard/src/app/
- `grep -r "Turnstile" dashboard/src/app/` shows Turnstile integration in login, signup, forgot-password
- `grep -r "customerAuth" dashboard/src/lib/api.ts` shows all API methods
- `grep "google" dashboard/src/app/login/page.tsx` shows Google button and callback handling
- Login page renders with all new elements visible
- Signup flow creates account and redirects to verification page
</verification>

<success_criteria>
1. Login page has Google button, forgot password link, signup link, and Turnstile widget
2. Signup page matches login visual design with email/password fields and Turnstile
3. "Check your email" page appears after signup with resend capability
4. Verify-email page uses two-step flow (GET shows button, POST confirms)
5. Forgot-password prevents email enumeration (generic response)
6. Reset-password validates password match and redirects to login with success banner
7. Google OAuth callback on login page handles token from query params
8. All pages use consistent design (zinc-900 card, brand colors, same input/button styles)
9. `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-foundation/05-03-SUMMARY.md`
</output>
