---
milestone: v1.0
audited: 2026-02-27T12:15:00Z
status: gaps_found
scores:
  requirements: 7/9
  phases: 3/3
  integration: 20/22
  flows: 3/4
gaps:
  requirements:
    - id: "MON-01"
      status: "partial"
      phase: "Phase 3"
      claimed_by_plans: ["03-02-PLAN.md"]
      completed_by_plans: ["03-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Offline webhooks fire correctly from worker process. Recovery webhooks never fire because api/main.go does not call deviceService.SetUserRepo(userRepo) — userRepo is nil in the API process, so sendRecoveryWebhook returns immediately at the nil guard."
    - id: "MON-02"
      status: "partial"
      phase: "Phase 3"
      claimed_by_plans: ["03-02-PLAN.md"]
      completed_by_plans: ["03-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Bandwidth enforcement works (packets dropped when limit exceeded). Reset Bandwidth only resets DB value — tunnel in-memory atomic counter is not reset. Next 30s flush overwrites DB zero with accumulated tunnel value, undoing the reset."
  integration:
    - from: "api/main.go"
      to: "device_service.go"
      issue: "SetUserRepo not called in API process — recovery webhooks silently dropped"
      requirement: "MON-01"
    - from: "connection_service.ResetBandwidth"
      to: "tunnel handleResetBandwidth"
      issue: "DB reset does not propagate to tunnel in-memory counter — 30s flush overwrites reset"
      requirement: "MON-02"
  flows:
    - flow: "Device offline → webhook → reconnect → recovery webhook"
      breaks_at: "Recovery webhook (Heartbeat → sendRecoveryWebhook) — userRepo nil in API process"
      requirement: "MON-01"
tech_debt:
  - phase: 02-dashboard
    items:
      - "Sidebar.tsx orphaned — implemented but not rendered (approved design change)"
      - "DASH-04 responsive layout needs human verification at 768px"
  - phase: 03-security-and-monitoring
    items:
      - "sync_service.go uses PasswordPlain wire field name to send PasswordHash value (backward compat)"
      - "GetWebhookURLForDevice returns first user's webhook URL (single-tenant assumption)"
---

# Milestone v1.0 Audit Report

**Audited:** 2026-02-27
**Status:** GAPS FOUND

## Scores

| Category | Score | Details |
|----------|-------|---------|
| Requirements | 7/9 | MON-01 partial (recovery webhook), MON-02 partial (reset bandwidth) |
| Phases | 3/3 | All phases complete with VERIFICATION.md |
| Integration | 20/22 | 2 cross-phase wiring gaps |
| E2E Flows | 3/4 | Flow C partially broken (recovery webhook) |

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | VERIFICATION.md | SUMMARY frontmatter | REQUIREMENTS.md | Final Status |
|--------|-----------------|---------------------|-----------------|--------------|
| PROTO-01 | passed | 01-01, 01-02 | [x] Complete | **satisfied** |
| PROTO-02 | passed | 01-02 | [x] Complete | **satisfied** |
| DASH-01 | passed (approved deviation) | 02-01, 02-03 | [x] Complete | **satisfied** |
| DASH-02 | passed (approved deviation) | 02-02, 02-03 | [x] Complete | **satisfied** |
| DASH-03 | passed | 02-02, 02-03 | [x] Complete | **satisfied** |
| DASH-04 | partial (human verify needed) | 02-01, 02-02, 02-03 | [x] Complete | **satisfied** |
| SEC-01 | passed | 03-01 | [x] Complete | **satisfied** |
| MON-01 | passed (code-level only) | 03-02 | [x] Complete | **partial** |
| MON-02 | passed (code-level only) | 03-02 | [x] Complete | **partial** |

No orphaned requirements found — all 9 REQ-IDs present in VERIFICATION.md, SUMMARY frontmatter, and traceability table.

## Critical Gaps

### Gap 1: Recovery Webhooks Never Fire (MON-01)

**Root cause:** `server/cmd/api/main.go` does not call `deviceService.SetUserRepo(userRepo)`.

The worker process correctly wires `SetUserRepo` (line 39 of `worker/main.go`), so **offline webhooks via stale detection work**. However, **recovery webhooks** are triggered from `Heartbeat()` in the API process, where `userRepo` is nil. The nil guard at `device_service.go:456` silently returns without sending.

**Fix:** Add `deviceService.SetUserRepo(userRepo)` in `api/main.go` after the existing `SetStatusLogRepo` call. `userRepo` is already instantiated at line 26.

**Severity:** Major — recovery notifications are a key part of MON-01 ("Device offline notification via webhook" implies knowing when it comes back).

### Gap 2: Reset Bandwidth Doesn't Reset Tunnel Counter (MON-02)

**Root cause:** `connection_service.ResetBandwidth` only calls `connRepo.ResetBandwidthUsed(ctx, id)` (DB reset). It does not call the tunnel's `/openvpn-client-reset-bandwidth` endpoint to reset the in-memory `atomic.Int64` counter.

**Consequence:** After clicking Reset Usage from the dashboard:
1. DB is set to 0
2. Tunnel counter keeps its accumulated value
3. Next 30-second flush overwrites DB zero with the tunnel's value
4. Usage "reappears" within 30 seconds

**Fix:** The tunnel already has `handleResetBandwidth` (accepts `client_vpn_ip`). Modify it to also accept `username` (match via `clientSocksAuth[ip].user`), then have `connService.ResetBandwidth` call the tunnel push API with the connection's username.

**Severity:** Major — the Reset Usage button in the dashboard is non-functional.

## E2E Flow Results

| Flow | Status | Issue |
|------|--------|-------|
| A: Create → bandwidth limit → enforce → reset | PARTIAL | Reset doesn't propagate to tunnel |
| B: Create OpenVPN → download .ovpn → bcrypt auth | COMPLETE | Full chain verified |
| C: Device offline → webhook → reconnect → recovery | PARTIAL | Recovery webhook silent (userRepo nil) |
| D: Regenerate password → new .ovpn → old rejected | COMPLETE | Full chain verified |

## Tech Debt (Non-Critical)

### Phase 2: Dashboard
- `Sidebar.tsx` orphaned (129 lines, implemented but not rendered — approved design change)
- DASH-04 responsive layout needs human verification at 768px viewport

### Phase 3: Security and Monitoring
- `sync_service.go` uses `PasswordPlain` wire field name to transmit `PasswordHash` value (backward compat)
- `GetWebhookURLForDevice` returns first user's webhook URL (single-tenant assumption)

## Recommended Actions

1. **Fix Gap 1** (1 line): Add `deviceService.SetUserRepo(userRepo)` in `api/main.go`
2. **Fix Gap 2** (~20 lines): Modify tunnel's `handleResetBandwidth` to accept username, add tunnel call to `connService.ResetBandwidth`

Both fixes are small, targeted, and don't require architectural changes.

---

*Audited: 2026-02-27*
*Auditor: Claude (gsd-integration-checker + orchestrator)*
