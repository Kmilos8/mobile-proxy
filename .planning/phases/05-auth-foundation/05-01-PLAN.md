---
phase: 05-auth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/migrations/011_customer_auth.up.sql
  - server/migrations/011_customer_auth.down.sql
  - server/internal/domain/models.go
  - server/internal/domain/config.go
  - server/internal/repository/customer_repo.go
  - server/internal/repository/customer_token_repo.go
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04]

must_haves:
  truths:
    - "customers table has password_hash, email_verified, google_id, google_email columns"
    - "customer_auth_tokens table exists with token_hash, type, expires_at columns"
    - "Customer domain struct includes all auth fields"
    - "Repository methods exist for GetByEmail, GetByGoogleID, CreateToken, GetValidToken, MarkTokenUsed"
  artifacts:
    - path: "server/migrations/011_customer_auth.up.sql"
      provides: "Schema migration adding auth columns to customers + customer_auth_tokens table"
      contains: "ALTER TABLE customers"
    - path: "server/migrations/011_customer_auth.down.sql"
      provides: "Rollback migration"
      contains: "DROP TABLE customer_auth_tokens"
    - path: "server/internal/domain/models.go"
      provides: "Extended Customer struct with auth fields, CustomerAuthToken struct, request/response types"
      contains: "CustomerAuthToken"
    - path: "server/internal/domain/config.go"
      provides: "Config structs for Google OAuth, Resend, and Turnstile"
      contains: "GoogleOAuthConfig"
    - path: "server/internal/repository/customer_repo.go"
      provides: "Auth-related query methods on CustomerRepository"
      contains: "GetByEmail"
    - path: "server/internal/repository/customer_token_repo.go"
      provides: "CRUD for customer_auth_tokens table"
      contains: "CustomerTokenRepository"
  key_links:
    - from: "server/internal/domain/models.go"
      to: "server/migrations/011_customer_auth.up.sql"
      via: "struct fields match DB columns"
      pattern: "PasswordHash.*password_hash"
    - from: "server/internal/repository/customer_token_repo.go"
      to: "server/internal/domain/models.go"
      via: "uses CustomerAuthToken struct"
      pattern: "domain\\.CustomerAuthToken"
---

<objective>
Create the database schema and data-access layer for customer authentication.

Purpose: All auth features (signup, login, email verification, Google OAuth, password reset) require new database columns on the `customers` table, a new `customer_auth_tokens` table, and corresponding Go domain models and repository methods. This is the foundation layer that Plan 02 (services/handlers) builds on.

Output: Migration files, extended domain models, customer repo auth methods, customer token repository.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-foundation/05-CONTEXT.md
@.planning/phases/05-auth-foundation/05-RESEARCH.md

<interfaces>
<!-- Existing patterns the executor needs to follow -->

From server/internal/domain/models.go:
```go
type Customer struct {
    ID        uuid.UUID `json:"id" db:"id"`
    Name      string    `json:"name" db:"name"`
    Email     string    `json:"email" db:"email"`
    Active    bool      `json:"active" db:"active"`
    CreatedAt time.Time `json:"created_at" db:"created_at"`
    UpdatedAt time.Time `json:"updated_at" db:"updated_at"`
}
```

From server/internal/repository/customer_repo.go:
```go
type CustomerRepository struct { db *DB }
func NewCustomerRepository(db *DB) *CustomerRepository
func (r *CustomerRepository) Create(ctx context.Context, c *domain.Customer) error
func (r *CustomerRepository) GetByID(ctx context.Context, id uuid.UUID) (*domain.Customer, error)
func (r *CustomerRepository) List(ctx context.Context) ([]domain.Customer, error)
func (r *CustomerRepository) Update(ctx context.Context, c *domain.Customer) error
```

From server/internal/domain/config.go:
```go
type Config struct {
    Server   ServerConfig   `json:"server"`
    Database DatabaseConfig `json:"database"`
    JWT      JWTConfig      `json:"jwt"`
    VPN      VPNConfig      `json:"vpn"`
    Ports    PortConfig     `json:"ports"`
}
```

From server/internal/repository/db.go:
```go
type DB struct { Pool *pgxpool.Pool }
func NewDB(dsn string) (*DB, error)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and domain model extensions</name>
  <files>
    server/migrations/011_customer_auth.up.sql
    server/migrations/011_customer_auth.down.sql
    server/internal/domain/models.go
    server/internal/domain/config.go
  </files>
  <action>
    1. Create `server/migrations/011_customer_auth.up.sql`:
       - ALTER TABLE customers ADD COLUMN password_hash VARCHAR(255) (nullable — Google-only users have no password)
       - ALTER TABLE customers ADD COLUMN email_verified BOOLEAN NOT NULL DEFAULT FALSE
       - ALTER TABLE customers ADD COLUMN google_id VARCHAR(255) UNIQUE (nullable — email-only users)
       - ALTER TABLE customers ADD COLUMN google_email VARCHAR(255) (nullable)
       - CREATE TABLE customer_auth_tokens with columns: id (UUID PK default uuid_generate_v4()), customer_id (UUID NOT NULL FK to customers ON DELETE CASCADE), token_hash (VARCHAR(255) NOT NULL UNIQUE), type (VARCHAR(50) NOT NULL CHECK IN ('email_verify', 'password_reset')), expires_at (TIMESTAMPTZ NOT NULL), used_at (TIMESTAMPTZ nullable), created_at (TIMESTAMPTZ NOT NULL DEFAULT NOW())
       - CREATE INDEX idx_customer_auth_tokens_hash ON customer_auth_tokens(token_hash)
       - CREATE INDEX idx_customer_auth_tokens_customer ON customer_auth_tokens(customer_id, type)

    2. Create `server/migrations/011_customer_auth.down.sql`:
       - DROP TABLE IF EXISTS customer_auth_tokens
       - ALTER TABLE customers DROP COLUMN IF EXISTS password_hash, DROP COLUMN IF EXISTS email_verified, DROP COLUMN IF EXISTS google_id, DROP COLUMN IF EXISTS google_email

    3. Extend `domain.Customer` struct in models.go — add fields AFTER the existing fields:
       - PasswordHash  *string `json:"-" db:"password_hash"` (pointer because nullable for Google-only)
       - EmailVerified bool    `json:"email_verified" db:"email_verified"`
       - GoogleID      *string `json:"-" db:"google_id"` (pointer, nullable)
       - GoogleEmail   *string `json:"google_email,omitempty" db:"google_email"` (pointer, nullable)

    4. Add new `CustomerAuthToken` struct to models.go:
       ```go
       type CustomerAuthToken struct {
           ID         uuid.UUID  `json:"id" db:"id"`
           CustomerID uuid.UUID  `json:"customer_id" db:"customer_id"`
           TokenHash  string     `json:"-" db:"token_hash"`
           Type       string     `json:"type" db:"type"` // "email_verify" or "password_reset"
           ExpiresAt  time.Time  `json:"expires_at" db:"expires_at"`
           UsedAt     *time.Time `json:"used_at,omitempty" db:"used_at"`
           CreatedAt  time.Time  `json:"created_at" db:"created_at"`
       }
       ```

    5. Add customer auth request/response types to models.go:
       ```go
       type CustomerSignupRequest struct {
           Email          string `json:"email" binding:"required,email"`
           Password       string `json:"password" binding:"required,min=8"`
           TurnstileToken string `json:"turnstile_token" binding:"required"`
       }

       type CustomerLoginRequest struct {
           Email          string `json:"email" binding:"required,email"`
           Password       string `json:"password" binding:"required"`
           TurnstileToken string `json:"turnstile_token" binding:"required"`
       }

       type CustomerLoginResponse struct {
           Token    string   `json:"token"`
           Customer Customer `json:"customer"`
       }

       type ForgotPasswordRequest struct {
           Email          string `json:"email" binding:"required,email"`
           TurnstileToken string `json:"turnstile_token" binding:"required"`
       }

       type ResetPasswordRequest struct {
           Token           string `json:"token" binding:"required"`
           Password        string `json:"password" binding:"required,min=8"`
           ConfirmPassword string `json:"confirm_password" binding:"required,min=8"`
       }

       type VerifyEmailRequest struct {
           Token string `json:"token" binding:"required"`
       }

       type ResendVerificationRequest struct {
           Email string `json:"email" binding:"required,email"`
       }
       ```

    6. Add config structs to `config.go` inside the Config struct:
       ```go
       // Add to Config struct:
       Google    GoogleOAuthConfig `json:"google"`
       Resend    ResendConfig      `json:"resend"`
       Turnstile TurnstileConfig   `json:"turnstile"`

       type GoogleOAuthConfig struct {
           ClientID     string `json:"client_id"`
           ClientSecret string `json:"client_secret"`
           RedirectURL  string `json:"redirect_url"`
       }

       type ResendConfig struct {
           APIKey     string `json:"api_key"`
           FromEmail  string `json:"from_email"`
           BaseURL    string `json:"base_url"` // dashboard base URL for links in emails
       }

       type TurnstileConfig struct {
           SiteKey   string `json:"site_key"`
           SecretKey string `json:"secret_key"`
       }
       ```
       Update `DefaultConfig()` to include sensible defaults for these new fields (empty strings — must be set via env vars).
  </action>
  <verify>
    Run `cd server && go build ./...` to confirm models.go and config.go compile with no errors. Visually confirm migration SQL is syntactically correct by reviewing the file.
  </verify>
  <done>
    Migration 011 exists with customer auth columns and customer_auth_tokens table. Customer struct has PasswordHash, EmailVerified, GoogleID, GoogleEmail fields. CustomerAuthToken struct exists. All request/response types for auth flows defined. Config struct has Google, Resend, Turnstile fields. Go compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Customer repository auth extensions and token repository</name>
  <files>
    server/internal/repository/customer_repo.go
    server/internal/repository/customer_token_repo.go
  </files>
  <action>
    1. Add auth-related methods to `customer_repo.go` — extend the existing `CustomerRepository` struct (do NOT create a new repo):

       - `GetByEmail(ctx, email string) (*domain.Customer, error)` — SELECT all columns including new auth fields (password_hash, email_verified, google_id, google_email). Use lowercase email comparison (WHERE LOWER(email) = LOWER($1)).

       - `GetByGoogleID(ctx, googleID string) (*domain.Customer, error)` — SELECT by google_id column.

       - `CreateWithAuth(ctx, c *domain.Customer) error` — INSERT including password_hash, email_verified, google_id, google_email columns. This is the auth-aware create (the existing Create method only inserts id, name, email for operator-managed customers).

       - `UpdateEmailVerified(ctx, id uuid.UUID, verified bool) error` — UPDATE customers SET email_verified = $2, updated_at = NOW() WHERE id = $1.

       - `UpdatePasswordHash(ctx, id uuid.UUID, hash string) error` — UPDATE customers SET password_hash = $2, updated_at = NOW() WHERE id = $1.

       - `LinkGoogleAccount(ctx, id uuid.UUID, googleID, googleEmail string) error` — UPDATE customers SET google_id = $2, google_email = $3, email_verified = true, updated_at = NOW() WHERE id = $1.

       - Update the existing `GetByID` and `List` methods to include the new columns in their SELECT queries (password_hash, email_verified, google_id, google_email). The Scan calls need to be updated to scan these new fields.

    2. Create `server/internal/repository/customer_token_repo.go` — new file, following the exact same pattern as other repos in the repository package:

       ```go
       type CustomerTokenRepository struct { db *DB }
       func NewCustomerTokenRepository(db *DB) *CustomerTokenRepository
       ```

       Methods:
       - `Create(ctx, token *domain.CustomerAuthToken) error` — INSERT INTO customer_auth_tokens with all fields.
       - `GetByHash(ctx, tokenHash string) (*domain.CustomerAuthToken, error)` — SELECT by token_hash WHERE used_at IS NULL AND expires_at > NOW(). This ensures only valid, unused, non-expired tokens are returned.
       - `MarkUsed(ctx, id uuid.UUID) error` — UPDATE customer_auth_tokens SET used_at = NOW() WHERE id = $1.
       - `DeleteByCustomerAndType(ctx, customerID uuid.UUID, tokenType string) error` — DELETE FROM customer_auth_tokens WHERE customer_id = $1 AND type = $2. Used to clean up old tokens when generating a new one (e.g., resend verification).
  </action>
  <verify>
    Run `cd server && go build ./...` to confirm all repository files compile. Check that CustomerTokenRepository is a valid Go struct with all methods compiling against the domain types.
  </verify>
  <done>
    CustomerRepository has GetByEmail, GetByGoogleID, CreateWithAuth, UpdateEmailVerified, UpdatePasswordHash, LinkGoogleAccount methods. Existing GetByID/List updated to include new columns. CustomerTokenRepository exists with Create, GetByHash, MarkUsed, DeleteByCustomerAndType methods. All code compiles.
  </done>
</task>

</tasks>

<verification>
- `cd server && go build ./...` passes with zero errors
- Migration 011 up/down files exist with correct SQL
- `grep -n "PasswordHash\|EmailVerified\|GoogleID\|CustomerAuthToken" server/internal/domain/models.go` shows all new types
- `grep -n "GetByEmail\|GetByGoogleID\|CreateWithAuth" server/internal/repository/customer_repo.go` shows auth methods
- `grep -n "CustomerTokenRepository\|GetByHash\|MarkUsed" server/internal/repository/customer_token_repo.go` shows token repo
</verification>

<success_criteria>
1. Migration 011 adds password_hash, email_verified, google_id, google_email to customers and creates customer_auth_tokens table
2. Domain models include Customer auth fields, CustomerAuthToken struct, and all request/response types
3. Config struct includes Google OAuth, Resend, and Turnstile configuration
4. Customer repo has all auth query methods; token repo has CRUD methods
5. `go build ./...` compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-foundation/05-01-SUMMARY.md`
</output>
