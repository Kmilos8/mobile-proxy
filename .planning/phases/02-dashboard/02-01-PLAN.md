---
phase: 02-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/package.json
  - dashboard/tailwind.config.ts
  - dashboard/src/app/globals.css
  - dashboard/src/app/layout.tsx
  - dashboard/src/components/ui/button.tsx
  - dashboard/src/components/ui/dialog.tsx
  - dashboard/src/components/ui/select.tsx
  - dashboard/src/components/ui/table.tsx
  - dashboard/src/components/ui/badge.tsx
  - dashboard/src/components/ui/separator.tsx
  - dashboard/src/components/ui/alert-dialog.tsx
  - dashboard/src/components/dashboard/Sidebar.tsx
  - dashboard/src/components/dashboard/DashboardLayout.tsx
  - dashboard/src/components/devices/StatBar.tsx
  - dashboard/src/components/devices/DeviceTable.tsx
  - dashboard/src/app/devices/page.tsx
  - dashboard/src/app/overview/page.tsx
  - dashboard/src/lib/api.ts
  - dashboard/components.json
  - server/internal/service/connection_service.go
autonomous: true
requirements:
  - DASH-01
  - DASH-04

must_haves:
  truths:
    - "Operator sees a dark-themed dashboard with Vercel/Linear aesthetic"
    - "Sidebar shows only 'Devices' navigation item and is collapsible"
    - "Home page (/devices) shows stat bar with total/online/offline device counts"
    - "Home page shows a sortable, filterable device table with name, status, IP, connection count columns"
    - "Offline devices are visually dimmed/grayed out in the table"
    - "Dashboard is usable on desktop (1024px+) and tablet (768px+) without horizontal scroll"
    - "/overview redirects to /devices"
    - "Backend accepts 'openvpn' as a valid proxy_type on POST /api/connections"
  artifacts:
    - path: "dashboard/components.json"
      provides: "shadcn/ui configuration"
    - path: "dashboard/src/components/dashboard/Sidebar.tsx"
      provides: "Collapsible sidebar with Devices-only nav"
      min_lines: 40
    - path: "dashboard/src/components/devices/DeviceTable.tsx"
      provides: "Sortable, filterable device table"
      min_lines: 60
    - path: "dashboard/src/components/devices/StatBar.tsx"
      provides: "Device count summary bar"
      min_lines: 15
    - path: "dashboard/src/app/devices/page.tsx"
      provides: "Rewritten home page with stat bar + table"
      min_lines: 50
  key_links:
    - from: "dashboard/src/app/devices/page.tsx"
      to: "dashboard/src/components/devices/DeviceTable.tsx"
      via: "import and render"
      pattern: "import.*DeviceTable"
    - from: "dashboard/src/app/devices/page.tsx"
      to: "dashboard/src/components/devices/StatBar.tsx"
      via: "import and render"
      pattern: "import.*StatBar"
    - from: "dashboard/src/components/dashboard/Sidebar.tsx"
      to: "localStorage"
      via: "persist collapsed state"
      pattern: "localStorage.*sidebar"
---

<objective>
Install shadcn/ui into the existing Next.js 14 dashboard, configure dark theme CSS variables, rewrite the sidebar to be collapsible with Devices-only navigation, and rebuild the /devices home page with a stat bar and sortable/filterable device table. Also add "openvpn" as a valid proxy_type in the backend connection service.

Purpose: Establish the design system foundation (shadcn/ui + dark theme) and deliver the primary home page experience — the device fleet overview. This unlocks Plan 02 which builds on these components for device detail and connection management.

Output: Working home page with stat bar + device table, collapsible sidebar, shadcn/ui installed, backend ready for OpenVPN connections.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard/02-CONTEXT.md
@.planning/phases/02-dashboard/02-RESEARCH.md
@dashboard/src/lib/api.ts
@dashboard/src/app/layout.tsx
@dashboard/tailwind.config.ts
@dashboard/src/app/globals.css
@dashboard/src/components/dashboard/Sidebar.tsx
@dashboard/src/components/dashboard/DashboardLayout.tsx
@dashboard/src/app/devices/page.tsx
@dashboard/package.json
@server/internal/service/connection_service.go

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From dashboard/src/lib/api.ts:
```typescript
export interface Device {
  id: string; name: string; description: string; android_id: string;
  status: 'online' | 'offline' | 'rotating' | 'error';
  cellular_ip: string; wifi_ip: string; vpn_ip: string;
  carrier: string; network_type: string;
  battery_level: number; battery_charging: boolean; signal_strength: number;
  base_port: number; http_port: number; socks5_port: number;
  last_heartbeat: string | null; app_version: string; device_model: string;
  android_version: string; relay_server_id: string | null; relay_server_ip: string;
  auto_rotate_minutes: number; created_at: string;
}

export interface ProxyConnection {
  id: string; device_id: string; customer_id: string | null;
  username: string; password?: string;
  proxy_type: 'http' | 'socks5';  // Will be extended to include 'openvpn'
  base_port: number | null; http_port: number | null; socks5_port: number | null;
  active: boolean; created_at: string;
}

export const api = {
  devices: {
    list: (token: string) => request<{ devices: Device[] }>('/devices', { token }),
    // ...
  },
  connections: {
    list: (token: string, deviceId?: string) => request<{ connections: ProxyConnection[] }>(...)
    // ...
  },
}
```

From dashboard/src/lib/utils.ts:
```typescript
export function cn(...inputs: ClassValue[]): string  // clsx + tailwind-merge
export function copyToClipboard(text: string): void
export function timeAgo(date: string | null): string
```

Existing patterns:
- All pages are 'use client' components
- Polling: setInterval(fetchFn, 15000) in useEffect with cleanup
- WebSocket: addWSHandler for device_update events
- Auth: getToken() from lib/auth.ts
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui, configure dark theme, add openvpn proxy_type to backend</name>
  <files>
    dashboard/package.json
    dashboard/components.json
    dashboard/tailwind.config.ts
    dashboard/src/app/globals.css
    dashboard/src/app/layout.tsx
    dashboard/src/lib/api.ts
    server/internal/service/connection_service.go
  </files>
  <action>
    **Step 1: Install shadcn/ui** (from dashboard/ directory)
    Run `npx shadcn@latest init` — when prompted:
    - TypeScript: yes
    - Style: default
    - Base color: zinc
    - CSS variables: yes
    - Components path: src/components/ui
    - Use existing tailwind.config.ts

    IMPORTANT: After init, verify `tailwind.config.ts` still has the `brand` color scale (50-950 emerald values) and the `boxShadow` glow extensions. If shadcn overwrote them, merge them back. The brand colors and glow shadows MUST be preserved.

    Then add required components:
    ```bash
    npx shadcn@latest add button dialog select table badge separator alert-dialog
    ```

    **Step 2: Configure dark theme CSS variables**
    Update `dashboard/src/app/globals.css` to set shadcn CSS variables for dark-only theme. Add these `:root` variables (replacing the existing `:root` block):
    ```css
    :root {
      --background: 0 0% 4%;
      --foreground: 0 0% 93%;
      --card: 0 0% 9%;
      --card-foreground: 0 0% 93%;
      --popover: 0 0% 9%;
      --popover-foreground: 0 0% 93%;
      --primary: 160 84% 39%;
      --primary-foreground: 0 0% 100%;
      --secondary: 0 0% 15%;
      --secondary-foreground: 0 0% 93%;
      --muted: 0 0% 15%;
      --muted-foreground: 0 0% 45%;
      --accent: 0 0% 15%;
      --accent-foreground: 0 0% 93%;
      --destructive: 0 84% 60%;
      --destructive-foreground: 0 0% 100%;
      --border: 0 0% 15%;
      --input: 0 0% 15%;
      --ring: 160 84% 39%;
      --radius: 0.5rem;
    }
    ```
    Keep ALL existing styles below :root (body, button/a transitions, card utilities, scrollbar styling).
    Keep the `--brand`, `--brand-dark` custom properties alongside the new ones.

    **Step 3: Add `dark` class to html tag**
    In `dashboard/src/app/layout.tsx`, add `dark` to the html className:
    ```tsx
    <html lang="en" className={`${inter.variable} dark`}>
    ```

    **Step 4: Update tailwind.config.ts**
    Ensure `darkMode: 'class'` is set in the config. Preserve existing brand colors and glow shadows. shadcn init may add `tailwindcss-animate` plugin — keep it if added.

    **Step 5: Update ProxyConnection type in api.ts**
    Change the `proxy_type` field from `'http' | 'socks5'` to `'http' | 'socks5' | 'openvpn'` in the `ProxyConnection` interface.

    **Step 6: Add "openvpn" to backend connection service**
    In `server/internal/service/connection_service.go`, update the proxy_type validation (around line 73):
    - Change `if proxyType != "http" && proxyType != "socks5"` to `if proxyType != "http" && proxyType != "socks5" && proxyType != "openvpn"`
    - After the port allocation block (around line 104-111), add a condition: when `proxyType == "openvpn"`, skip port allocation entirely (no BasePort, no HTTPPort, no SOCKS5Port). OpenVPN uses the shared server port 1195.
    - Skip the DNAT refresh call for openvpn connections (no port to DNAT).
  </action>
  <verify>
    <automated>cd dashboard && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - shadcn/ui installed with button, dialog, select, table, badge, separator, alert-dialog components
    - Dark theme CSS variables set; brand colors preserved
    - `dark` class on html tag
    - ProxyConnection type includes 'openvpn'
    - Backend accepts "openvpn" as proxy_type without port allocation
    - `next build` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite sidebar (collapsible, Devices-only) and DashboardLayout</name>
  <files>
    dashboard/src/components/dashboard/Sidebar.tsx
    dashboard/src/components/dashboard/DashboardLayout.tsx
    dashboard/src/app/overview/page.tsx
  </files>
  <action>
    **Rewrite Sidebar.tsx:**
    - Single nav item: "Devices" (href="/devices", icon: Smartphone from lucide-react)
    - Remove Overview, Connections, Customers from nav
    - Collapsible: toggle button (ChevronLeft/ChevronRight icon) in the header area
    - Collapsed state: icon-only mode, width ~64px. Expanded: ~220px
    - Persist collapsed state in localStorage key "sidebar-collapsed"
    - Read localStorage ONLY in useEffect (not in initial state) to avoid hydration mismatch — default to expanded (false)
    - Brand logo + "PocketProxy" text in header — hide text when collapsed, show only logo
    - Sign Out button at bottom — show only icon when collapsed
    - Use `transition-all duration-200` on the aside width for smooth animation
    - Dark styling: bg-zinc-900, border-r border-zinc-800 — consistent with existing
    - Active nav item: use brand color highlight (bg-brand-500/15 text-brand-400)
    - At `md` breakpoint (768px): sidebar starts collapsed by default. At `lg` (1024px+): respect localStorage. Use window.innerWidth check in useEffect.

    **Update DashboardLayout.tsx:**
    - Pass collapsed state to children or simply let Sidebar manage its own width
    - Main content area adjusts via flex layout (flex-1 fills remaining space naturally)
    - Keep existing auth check and WebSocket connection logic exactly as-is

    **Redirect /overview to /devices:**
    Replace `dashboard/src/app/overview/page.tsx` with a simple redirect:
    ```tsx
    import { redirect } from 'next/navigation'
    export default function OverviewPage() { redirect('/devices') }
    ```
    If there's an overview layout.tsx, keep it or remove it — the redirect makes it irrelevant.
  </action>
  <verify>
    <automated>cd dashboard && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Sidebar shows only "Devices" nav item
    - Sidebar toggles between collapsed (64px, icon-only) and expanded (220px, labels visible)
    - Collapsed state persists in localStorage without hydration mismatch
    - At 768px viewport, sidebar defaults to collapsed
    - /overview redirects to /devices
    - Sign Out button works in both states
    - `next build` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Rebuild /devices home page with StatBar and sortable DeviceTable</name>
  <files>
    dashboard/src/components/devices/StatBar.tsx
    dashboard/src/components/devices/DeviceTable.tsx
    dashboard/src/app/devices/page.tsx
  </files>
  <action>
    **Create StatBar.tsx** (`dashboard/src/components/devices/StatBar.tsx`):
    - Three stat boxes in a row: Total Devices, Online, Offline
    - Accepts props: `{ total: number, online: number, offline: number }`
    - Styling: bg-zinc-900 border border-zinc-800 rounded-lg, each stat showing count + label
    - Online count in green, offline in zinc-500 (dimmed)
    - Per locked decision: devices only, no connection counts in stat bar

    **Create DeviceTable.tsx** (`dashboard/src/components/devices/DeviceTable.tsx`):
    - Dense table/list layout (locked decision: NOT cards)
    - Columns: Device Name, Status, IP (cellular_ip), Connection Count
    - Props: `{ devices: Device[], connectionCounts: Record<string, number> }`
    - Client-side sort: click column header to toggle sort (asc/desc). Default sort: name ascending.
    - Sort indicator: arrow up/down icon next to active sort column header
    - Filter: status filter dropdown (All / Online / Offline) above or beside the table
    - Use shadcn Table components (Table, TableHead, TableRow, TableCell, TableHeader, TableBody)
    - Offline devices: entire row gets `opacity-50` or `text-zinc-500` styling (visually dimmed, locked decision)
    - Row is clickable — navigates to `/devices/{id}` (use Next.js Link or router.push)
    - Show StatusBadge for status column (reuse existing component)
    - Connection count: rendered from connectionCounts map (`connectionCounts[device.id] || 0`)
    - Responsive: on screens < 768px, hide IP column; keep name, status, count

    **Rewrite devices/page.tsx:**
    - Keep existing data fetching pattern: fetchDevices with useCallback, polling at 15s, WebSocket device_update handler
    - Add: fetch all connections once at page load via `api.connections.list(token)` (no device_id filter) to compute connection counts per device. Store as `Record<string, number>` in state.
    - Render: StatBar at top, then filter controls, then DeviceTable
    - Keep PairingModal and pairing code display exactly as-is (working feature, do not modify)
    - Keep "Add Device" button that opens PairingModal
    - Keep active pairing codes display above the table
    - Remove the old card-style device list; replace with DeviceTable component
    - The stat bar numbers derive from the devices array: `total = devices.length`, `online = devices.filter(d => d.status === 'online').length`, `offline = total - online`
  </action>
  <verify>
    <automated>cd dashboard && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - /devices shows stat bar with total/online/offline counts
    - Device table with 4 columns (name, status, IP, connection count)
    - Columns are sortable (click header toggles asc/desc)
    - Status filter works (All/Online/Offline)
    - Offline devices are visually dimmed
    - Clicking a device row navigates to /devices/{id}
    - Auto-refresh (15s polling + WebSocket) continues to work
    - Pairing modal and active codes still functional
    - `next build` succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npx next build` completes without errors
2. `/devices` route renders stat bar + sortable table
3. `/overview` redirects to `/devices`
4. Sidebar shows only "Devices" and collapses/expands correctly
5. Backend: `curl -X POST /api/connections -d '{"device_id":"...","username":"test","password":"test","proxy_type":"openvpn"}' -H "Authorization: Bearer ..."` returns 200 (not 500)
</verification>

<success_criteria>
- shadcn/ui components available and dark-themed
- Home page delivers dense device table with sort + filter
- Sidebar is collapsible with Devices-only navigation
- Layout works at 768px and 1024px without horizontal scroll
- Backend accepts openvpn proxy_type
- All existing features (pairing, WebSocket, polling) continue working
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard/02-01-SUMMARY.md`
</output>
