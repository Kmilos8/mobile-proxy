---
phase: 02-dashboard
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - dashboard/src/app/devices/[id]/page.tsx
  - dashboard/src/components/connections/ConnectionTable.tsx
  - dashboard/src/components/connections/AddConnectionModal.tsx
  - dashboard/src/components/connections/DeleteConnectionDialog.tsx
autonomous: true
requirements:
  - DASH-02
  - DASH-03
  - DASH-04

must_haves:
  truths:
    - "Operator can see all connections for a device in a table with type, port, username, password, status"
    - "Operator can create a new connection (HTTP, SOCKS5, or OpenVPN) from the device detail page via a modal dialog"
    - "After creating a connection, the modal closes and the new connection appears in the list"
    - "Operator can see each credential field (host, port, username, password) with per-field copy buttons"
    - "Operator can click 'Copy All' to get URL format: protocol://username:password@host:port"
    - "OpenVPN connections show a download button for the .ovpn file"
    - "Operator can delete a connection with a confirmation dialog"
    - "Device detail page is usable on tablet (768px+)"
  artifacts:
    - path: "dashboard/src/components/connections/ConnectionTable.tsx"
      provides: "Per-device connection list with credentials and copy buttons"
      min_lines: 80
    - path: "dashboard/src/components/connections/AddConnectionModal.tsx"
      provides: "Modal dialog for creating HTTP/SOCKS5/OpenVPN connections"
      min_lines: 60
    - path: "dashboard/src/components/connections/DeleteConnectionDialog.tsx"
      provides: "Confirmation dialog for connection deletion"
      min_lines: 30
    - path: "dashboard/src/app/devices/[id]/page.tsx"
      provides: "Rewritten device detail page with connection management section"
      min_lines: 100
  key_links:
    - from: "dashboard/src/components/connections/AddConnectionModal.tsx"
      to: "api.connections.create"
      via: "POST call with device_id, username, password, proxy_type"
      pattern: "api\\.connections\\.create"
    - from: "dashboard/src/components/connections/DeleteConnectionDialog.tsx"
      to: "api.connections.delete"
      via: "DELETE call with connection id"
      pattern: "api\\.connections\\.delete"
    - from: "dashboard/src/components/connections/ConnectionTable.tsx"
      to: "api.connections.downloadOVPN"
      via: ".ovpn file download for OpenVPN connections"
      pattern: "downloadOVPN"
    - from: "dashboard/src/app/devices/[id]/page.tsx"
      to: "dashboard/src/components/connections/ConnectionTable.tsx"
      via: "import and render with connections data"
      pattern: "import.*ConnectionTable"
---

<objective>
Rebuild the device detail page with a full connection management section: connection table with per-field credential copy, Add Connection modal (protocol selector for HTTP/SOCKS5/OpenVPN), delete confirmation dialog, and .ovpn download for OpenVPN connections.

Purpose: Deliver the core connection management experience — operators can create, view, copy, and delete proxy connections entirely from the dashboard without touching the API.

Output: Fully functional device detail page with connection CRUD, credential display with copy, and .ovpn download.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard/02-CONTEXT.md
@.planning/phases/02-dashboard/02-RESEARCH.md
@.planning/phases/02-dashboard/02-01-SUMMARY.md
@dashboard/src/lib/api.ts
@dashboard/src/app/devices/[id]/page.tsx

<interfaces>
<!-- From Plan 01 — shadcn/ui components now available -->

shadcn/ui components installed by Plan 01 (import from @/components/ui/):
- Button: `<Button variant="default|ghost|destructive|outline" size="default|sm|icon">`
- Dialog: `Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogClose`
- AlertDialog: `AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger`
- Select: `Select, SelectContent, SelectItem, SelectTrigger, SelectValue`
- Table: `Table, TableBody, TableCell, TableHead, TableHeader, TableRow`
- Badge: `<Badge variant="default|secondary|destructive|outline">`

From dashboard/src/lib/api.ts (updated by Plan 01):
```typescript
export interface ProxyConnection {
  id: string; device_id: string; customer_id: string | null;
  username: string; password?: string;
  proxy_type: 'http' | 'socks5' | 'openvpn';
  base_port: number | null; http_port: number | null; socks5_port: number | null;
  active: boolean; created_at: string;
}

api.connections.create(token, { device_id, username, password, proxy_type?, ip_whitelist?, bandwidth_limit? })
api.connections.delete(token, id)
api.connections.downloadOVPN(token, id)  // triggers browser download
api.connections.list(token, deviceId?)
```

From dashboard/src/lib/utils.ts:
```typescript
export function cn(...inputs: ClassValue[]): string
export function copyToClipboard(text: string): void
export function timeAgo(date: string | null): string
export function formatBytes(bytes: number): string
export function formatDate(date: string): string
```

SERVER_HOST constant: `process.env.NEXT_PUBLIC_SERVER_HOST || '178.156.240.184'`
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionTable, AddConnectionModal, and DeleteConnectionDialog components</name>
  <files>
    dashboard/src/components/connections/ConnectionTable.tsx
    dashboard/src/components/connections/AddConnectionModal.tsx
    dashboard/src/components/connections/DeleteConnectionDialog.tsx
  </files>
  <action>
    **Create ConnectionTable.tsx:**
    - Props: `{ connections: ProxyConnection[], device: Device, serverHost: string, onDelete: (id: string) => void, onRefresh: () => void }`
    - Use shadcn Table components for layout
    - Each connection row shows: Type (badge: HTTP/SOCKS5/OpenVPN), Port, Username, Password, Status, Actions
    - **Credential display (locked decision: always visible, no masking):**
      - Host: `serverHost` (same for all) with copy button
      - Port: `conn.http_port` for HTTP, `conn.socks5_port` for SOCKS5, "1195" for OpenVPN — with copy button
      - Username: `conn.username` with copy button
      - Password: `conn.password` with copy button (render directly, NO `|| '********'` fallback per locked decision)
    - **Per-field copy buttons:** Small copy icon button next to each field. On click, copies that field value. Show brief "Copied!" feedback (inline state, 2s timeout).
    - **"Copy All" button** per connection row: copies URL format `protocol://username:password@host:port`. For OpenVPN: no Copy All (not applicable — show download button instead).
      - HTTP format: `http://username:password@host:port`
      - SOCKS5 format: `socks5://username:password@host:port`
    - **OpenVPN connections:** Show a download button (Download icon from lucide-react) that calls `api.connections.downloadOVPN(token, conn.id)`. No "Copy All" for OpenVPN.
    - **Delete button:** Trash2 icon button per row, opens DeleteConnectionDialog
    - Empty state: "No connections yet. Click 'Add Connection' to create one."
    - Responsive: At < 768px, stack credential fields vertically instead of wide table

    **Create AddConnectionModal.tsx:**
    - Props: `{ deviceId: string, open: boolean, onOpenChange: (open: boolean) => void, onCreated: () => void }`
    - Uses shadcn Dialog component
    - Form fields:
      - Protocol selector: shadcn Select with options HTTP, SOCKS5, OpenVPN
      - Username: text input (auto-generate a random username as default, e.g., `user_${Math.random().toString(36).slice(2, 8)}`)
      - Password: text input (auto-generate a random password, e.g., `Math.random().toString(36).slice(2, 14)`)
    - Submit: calls `api.connections.create(token, { device_id: deviceId, username, password, proxy_type })`. Default proxy_type to "http" if not selected.
    - On success: close modal, call `onCreated()` to refresh parent
    - On error: show error message inline in the dialog
    - Loading state: disable submit button and show spinner/loading text during API call
    - Dark themed: uses shadcn Dialog which inherits CSS variable theme

    **Create DeleteConnectionDialog.tsx:**
    - Props: `{ connection: ProxyConnection | null, open: boolean, onOpenChange: (open: boolean) => void, onConfirm: (id: string) => void }`
    - Uses shadcn AlertDialog
    - Title: "Delete connection?"
    - Description: "This will free the port and remove the connection. This action cannot be undone."
    - Cancel + Delete buttons
    - Delete button styled with destructive variant (red)
    - On confirm: calls `onConfirm(connection.id)` — parent handles API call
  </action>
  <verify>
    <automated>cd dashboard && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - ConnectionTable renders connection list with per-field copy buttons and Copy All
    - AddConnectionModal shows protocol selector (HTTP/SOCKS5/OpenVPN) and creates connections
    - DeleteConnectionDialog shows confirmation before deletion
    - All three components build without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite device detail page with connection management section</name>
  <files>
    dashboard/src/app/devices/[id]/page.tsx
  </files>
  <action>
    **Rewrite the device detail page** to integrate connection management as a first-class section. Keep the existing tab structure (Primary, Advanced, Change IP, History, Metrics, Usage) but redesign the Primary tab to prominently feature the connection management section.

    **Page structure:**
    - Back link to /devices (keep existing)
    - Device header: name, status badge, model, device ID (keep existing pattern)
    - Left sidebar tabs: same tabs as before (Primary, Advanced, Change IP, History, Metrics, Usage)
    - Command feedback toast: keep as-is

    **Primary tab redesign:**
    - Remove the old "Proxy" sub-tab with separate HTTP and SOCKS5 tables
    - Replace with:
      1. "Add Connection" button (top right of connections section, uses shadcn Button with Plus icon)
      2. ConnectionTable component showing ALL connections (HTTP, SOCKS5, OpenVPN) in a unified table
      3. External IP display below connections (keep existing)
    - Keep the "Basic Info" sub-tab as-is
    - The "Add Connection" button opens AddConnectionModal
    - After creating a connection, call fetchData to refresh
    - Delete flow: DeleteConnectionDialog confirmation → call `api.connections.delete(token, id)` → fetchData to refresh

    **Keep ALL other tabs exactly as-is:**
    - AdvancedTab: remote commands (rotate, find phone, reboot, command history)
    - ChangeIPTab: auto-rotation interval, rotation links
    - HistoryTab: IP history table
    - MetricsTab: battery, device info, network sub-tabs
    - UsageTab: bandwidth chart + uptime timeline
    - InfoRow helper component

    **These existing features MUST be preserved without modification:**
    - fetchData polling (15s interval)
    - WebSocket device_update handler
    - All tab content
    - PairingModal (not used on this page, but don't break imports)

    **Responsive (DASH-04):**
    - At 768px: sidebar tabs collapse or stack. Connection table fields stack vertically.
    - The page layout already uses flex — the sidebar tabs section can use `hidden md:block` and show a horizontal tab bar on mobile instead.
  </action>
  <verify>
    <automated>cd dashboard && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Device detail page shows unified connection table with all protocol types
    - "Add Connection" button opens modal with HTTP/SOCKS5/OpenVPN selector
    - Created connection appears in list after creation (no page refresh needed)
    - Per-field copy buttons work for host, port, username, password
    - "Copy All" produces URL format for HTTP/SOCKS5
    - OpenVPN connections show .ovpn download button
    - Delete with confirmation dialog works — connection removed from list
    - All existing tabs (Advanced, Change IP, History, Metrics, Usage) remain functional
    - Layout usable at 768px+ without horizontal scroll
    - `next build` succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npx next build` completes without errors
2. Device detail page at `/devices/{id}` shows connection table with credentials
3. "Add Connection" creates HTTP, SOCKS5, and OpenVPN connections successfully
4. Copy All produces correct URL format for HTTP and SOCKS5
5. OpenVPN connections show download button (no Copy All)
6. Delete connection with confirmation works
7. All existing tabs (Advanced, Change IP, History, Metrics, Usage) still functional
8. Page layout works at 768px viewport width
</verification>

<success_criteria>
- Connection CRUD fully operational from dashboard (no API needed)
- Credentials displayed in plaintext with per-field copy
- Copy All URL format correct for each protocol
- .ovpn download works for OpenVPN connections
- All existing device detail features preserved
- Responsive at 768px+
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard/02-02-SUMMARY.md`
</output>
